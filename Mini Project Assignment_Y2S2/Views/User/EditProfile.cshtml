@model Mini_Project_Assignment_Y2S2.Models.EditProfileViewModel

@{
	ViewBag.Title = "Edit Profile";
}
<link rel="stylesheet" href="~/css/user.css" asp-append-version="true" />

<div class="container">
    <div class="login-card">
        <div class="login-title">Edit Profile</div>

        <form asp-action="EditProfile" method="post" enctype="multipart/form-data">

            <div class="profile-pic-container">
                <input value="@Model?.ProfileImageUrl" asp-for="ProfileImageUrl" hidden>

                @if (!string.IsNullOrEmpty(Model?.ProfileImageUrl))
                {
                    <img id="profilePreview" src="@Model.ProfileImageUrl" alt="Profile" class="profile-pic" />
                    <div id="profilePlaceholder" class="profile-placeholder" style="display: none;">
                        Click to Change Picture
                    </div>
                }
                else
                {
                    <div id="profilePlaceholder" class="profile-placeholder">
                        Click to Add Picture
                    </div>
                }

                <input type="file" name="ProfileImage" accept="image/*" id="profileInput" hidden />
            </div>

            <div class="form-group">
                <label asp-for="Name"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="Email"></label>
                <input asp-for="Email" class="form-control" />
                <span asp-validation-for="Email" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="PhoneNumber"></label>
                <input asp-for="PhoneNumber" class="form-control" />
                <span asp-validation-for="PhoneNumber" class="text-danger"></span>
            </div>

            <button type="button" onclick="location.href='@Url.Action("MyAccount")'" class="btn-cancel">Cancel</button>
            <button type="submit" class="btn-change">Save Changes</button>

        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}

<style>
    .profile-pic-container {
        width: 140px;
        height: 140px;
        border-radius: 50%;
        margin: 0 auto 20px auto;
        overflow: hidden;
        cursor: pointer;
        border: 3px solid #ccc;
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 14px;
        color: #666;
        background-color: #f0f0f0;
        text-align: center;
        transition: 0.3s;
    }

        .profile-pic-container:hover {
            opacity: 0.8;
        }

    .profile-pic {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .profile-placeholder {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
    }

</style>

<script>
    const profileInput = document.getElementById('profileInput');
    const profileContainer = document.querySelector('.profile-pic-container');

    profileContainer.addEventListener('click', function () {
        profileInput.click();
    });

    profileInput.addEventListener('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        // 验证文件类型
        if (!file.type.match('image.*')) {
            alert('Please select an image file.');
            return;
        }

        // 验证文件大小（例如限制在5MB以内）
        if (file.size > 5 * 1024 * 1024) {
            alert('Image size should be less than 5MB.');
            return;
        }

        const reader = new FileReader();

        reader.onload = function(e) {
            const result = e.target.result;

            // 检查是否已存在预览图片
            let profilePreview = document.getElementById('profilePreview');
            const profilePlaceholder = document.getElementById('profilePlaceholder');

            if (profilePreview) {
                // 更新现有图片
                profilePreview.src = result;
            } else if (profilePlaceholder) {
                // 移除占位符并创建新图片
                profilePlaceholder.remove();

                const img = document.createElement('img');
                img.id = 'profilePreview';
                img.src = result;
                img.alt = 'Profile Preview';
                img.classList.add('profile-pic');
                profileContainer.prepend(img);
            } else {
                // 如果既没有预览图也没有占位符，创建新图片
                const img = document.createElement('img');
                img.id = 'profilePreview';
                img.src = result;
                img.alt = 'Profile Preview';
                img.classList.add('profile-pic');
                profileContainer.prepend(img);
            }
        };

        reader.onerror = function() {
            alert('Failed to read the image file.');
        };

        reader.readAsDataURL(file);
    });

    // 添加一些CSS来改善用户体验
    const style = document.createElement('style');
    style.textContent = `
        .profile-pic-container img.profile-pic {
            transition: opacity 0.3s ease;
        }
        .profile-pic-container:hover img.profile-pic {
            opacity: 0.8;
        }
    `;
    document.head.appendChild(style);
</script>